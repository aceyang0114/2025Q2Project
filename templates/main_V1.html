<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="{{ url_for('static', filename='Image/favicon.ico') }}" type="image/x-icon">
  <title>å·¡æª¢ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
  <h2>è¼¸å…¥å·¡æª¢è³‡è¨Š</h2>

  <label>å·¡æª¢ç³»çµ±<input type="text" id="System" /></label><br>
  <label>å·¡æª¢é»ç·¨è™Ÿ<input type="text" id="Number" /></label><br>

  <button onclick="saveData()">â• å„²å­˜åˆ°æœ¬åœ°</button>
  <button onclick="uploadData()">ğŸ“¤ ä¸Šå‚³æ‰€æœ‰è³‡æ–™</button><br><br>

  <!-- é¡é ­ç•«é¢èˆ‡æ‹ç…§åŠŸèƒ½ -->
  <video id="video" width="300" autoplay muted playsinline></video><br>
  <button onclick="startCamera()">ğŸ“· å•Ÿç”¨é¡é ­</button>
  <button onclick="captureAndRecognize()">ğŸ“¸ æ‹ç…§ä¸¦è¾¨è­˜</button><br>
  <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>

  <p id="status">ğŸ“¦ æœ¬åœ°æš«å­˜ç­†æ•¸ï¼š0</p>
  <p id="ocr-status"></p>

  <script>
    let db;
    const request = indexedDB.open("BusinessCardDB", 1);

    request.onerror = (e) => console.error("âŒ è³‡æ–™åº«é–‹å•Ÿå¤±æ•—", e);

    request.onsuccess = (e) => {
      db = e.target.result;
      updateCount();
    };

    request.onupgradeneeded = (e) => {
      db = e.target.result;
      db.createObjectStore("cards", { keyPath: "id", autoIncrement: true });
    };

    function saveData() {
      const System = document.getElementById("System").value.trim();
      const Number = document.getElementById("Number").value.trim();

      if (!System || !Number) {
        alert("è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰æ¬„ä½ï¼");
        return;
      }

      const tx = db.transaction("cards", "readwrite");
      const store = tx.objectStore("cards");
      store.add({ System, Number });
      tx.oncomplete = () => {
        document.getElementById("System").value = '';
        document.getElementById("Number").value = '';
        updateCount();
        alert("âœ… å·²å„²å­˜è‡³æœ¬åœ°");
      };
    }

    function updateCount() {
      const tx = db.transaction("cards", "readonly");
      const store = tx.objectStore("cards");
      const countReq = store.count();
      countReq.onsuccess = () => {
        document.getElementById("status").textContent = `ğŸ“¦ æœ¬åœ°æš«å­˜ç­†æ•¸ï¼š${countReq.result}`;
      };
    }

    function uploadData() {
      const tx = db.transaction("cards", "readonly");
      const store = tx.objectStore("cards");
      const getAll = store.getAll();

      getAll.onsuccess = () => {
        const data = getAll.result;
        if (data.length === 0) {
          alert("âš ï¸ æ²’æœ‰å¯ä¸Šå‚³çš„è³‡æ–™ï¼");
          return;
        }

        fetch("/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
        .then(res => res.json())
        .then(res => {
          if (res.success) {
            const clearTx = db.transaction("cards", "readwrite");
            clearTx.objectStore("cards").clear();
            updateCount();
            alert("âœ… ä¸Šå‚³æˆåŠŸï¼Œå·²æ¸…é™¤æœ¬åœ°è³‡æ–™");
          } else {
            alert("âŒ ä¸Šå‚³å¤±æ•—");
          }
        });
      };
    }

    // ========= é¡é ­æ‹ç…§èˆ‡ OCR åŠŸèƒ½ =========

    let stream;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById("video").srcObject = stream;
      } catch (err) {
        alert("ç„¡æ³•å•Ÿç”¨é¡é ­ï¼š" + err.message);
      }
    }

    function captureAndRecognize() {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // å‹•æ…‹è¨­è§£æåº¦
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // æ‹ç…§
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // å®šç¾©è£åˆ‡å€åŸŸ
      const systemBox = { x: 50, y: 30, width: 400, height: 50 };
      const numberBox = { x: 50, y: 90, width: 400, height: 50 };

      // å»ºç«‹å­ Canvas é€²è¡Œè£åˆ‡
      function cropAndOCR(box, callback) {
        const subCanvas = document.createElement("canvas");
        subCanvas.width = box.width;
        subCanvas.height = box.height;
        const subCtx = subCanvas.getContext("2d");
        subCtx.drawImage(canvas, box.x, box.y, box.width, box.height, 0, 0, box.width, box.height);
        const dataURL = subCanvas.toDataURL("image/png");

        Tesseract.recognize(dataURL, 'chi_tra+eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          callback(text.trim());
        }).catch(err => {
          console.error("OCR éŒ¯èª¤ï¼š", err);
          callback("");
        });
      }

      document.getElementById("ocr-status").textContent = "ğŸ” æ­£åœ¨è¾¨è­˜å…©å€‹æ¬„ä½...";

      // åŒæ­¥è¾¨è­˜å…©å€‹æ¬„ä½
      cropAndOCR(systemBox, (systemText) => {
        cropAndOCR(numberBox, (numberText) => {
          console.log("Systemï¼š", systemText);
          console.log("Numberï¼š", numberText);

          // è¨­å®šåˆ°æ¬„ä½
          document.getElementById("System").value = systemText;
          document.getElementById("Number").value = numberText;

          document.getElementById("ocr-status").textContent = "âœ… å·²è¾¨è­˜ä¸¦å¡«å…¥æ¬„ä½";

          if (!systemText || !numberText) {
            alert("âš ï¸ æœ‰æ¬„ä½æœªèƒ½è¾¨è­˜æˆåŠŸï¼Œè«‹ç¢ºèªå½±åƒæ¸…æ™°åº¦æˆ–æ‰‹å‹•å¡«å…¥");
          }
        });
      });
    }

  </script>
</body>
</html>
