<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{{ url_for('static', filename='Image/favicon.ico') }}" type="image/x-icon">
    <title>å·¡æª¢ç³»çµ±ï¼ˆé›¢ç·šç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
<h2>è¼¸å…¥å·¡æª¢è³‡è¨Š</h2>

<label>å·¡æª¢ç³»çµ±<input type="text" id="System"></label><br>
<label>å·¡æª¢é»ç·¨è™Ÿ<input type="text" id="Number"></label><br>

<button onclick="saveData()">â• å„²å­˜åˆ°æœ¬åœ°</button>
<button onclick="uploadData()">ğŸ“¤ ä¸Šå‚³æ‰€æœ‰è³‡æ–™</button><br><br>

<video id="video" width="300" autoplay muted playsinline></video><br>
<button onclick="startCamera()">ğŸ“· å•Ÿç”¨é¡é ­</button>
<button onclick="captureAndRecognize()">ğŸ“¸ æ‹ç…§ä¸¦è¾¨è­˜</button><br>

<p id="status">ğŸ“¦ æœ¬åœ°æš«å­˜ç­†æ•¸ï¼š0</p>
<p id="ocr-status"></p>

<script>
    let db;
    const request = indexedDB.open("BusinessCardDB", 1);

    request.onerror = (e) => console.error("âŒ è³‡æ–™åº«é–‹å•Ÿå¤±æ•—", e);

    request.onsuccess = (e) => {
        db = e.target.result;
        updateCount();
    };

    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("cards", { keyPath: "id", autoIncrement: true });
    };

    function saveData() {
        const System = document.getElementById("System").value.trim();
        const Number = document.getElementById("Number").value.trim();
        if (!System || !Number) {
            alert("è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰æ¬„ä½ï¼");
            return;
        }
        const tx = db.transaction("cards", "readwrite");
        const store = tx.objectStore("cards");
        store.add({ System, Number });
        tx.oncomplete = () => {
            document.getElementById("System").value = '';
            document.getElementById("Number").value = '';
            updateCount();
            alert("âœ… å·²å„²å­˜è‡³æœ¬åœ°");
        };
    }

    function updateCount() {
        const tx = db.transaction("cards", "readonly");
        const store = tx.objectStore("cards");
        const countReq = store.count();
        countReq.onsuccess = () => {
            document.getElementById("status").textContent = `ğŸ“¦ æœ¬åœ°æš«å­˜ç­†æ•¸ï¼š${countReq.result}`;
        };
    }

    let stream;
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById("video").srcObject = stream;
        } catch (err) {
            alert("ç„¡æ³•å•Ÿç”¨é¡é ­ï¼š" + err.message);
        }
    }

    async function captureAndRecognize() {
        const video = document.getElementById("video");
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL("image/png");
        document.getElementById("ocr-status").textContent = "ğŸ” æ­£åœ¨è¾¨è­˜å½±åƒä¸­...";

        const imgTensor = await imageToTensor(canvas);
        const session = await ort.InferenceSession.create("/static/model/your_model.onnx");
        const feeds = { input: imgTensor };
        const results = await session.run(feeds);

        const output = results.output.data;
        const text = decodeText(output);

        document.getElementById("ocr-status").textContent = "âœ… å·²è¾¨è­˜å®Œæˆ";
        document.getElementById("System").value = text.system || "";
        document.getElementById("Number").value = text.number || "";
    }

    async function imageToTensor(canvas) {
        const ctx = canvas.getContext("2d");
        const { data, width, height } = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const floatArray = new Float32Array(width * height * 3);
        for (let i = 0; i < width * height; i++) {
            floatArray[i * 3] = data[i * 4] / 255.0;
            floatArray[i * 3 + 1] = data[i * 4 + 1] / 255.0;
            floatArray[i * 3 + 2] = data[i * 4 + 2] / 255.0;
        }
        return new ort.Tensor("float32", floatArray, [1, 3, height, width]);
    }

    function decodeText(output) {
        // å‡è¨­ä½ è¨“ç·´æ™‚ä½¿ç”¨ CTC ä¸¦æœ‰å­—å…¸
        const dictionary = [..."0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-å€¼ç­å®¤GC"];
        const indices = Array.from(output).map(i => Math.round(i));
        const chars = indices.map(i => dictionary[i] || '').join('');
        const system = chars.split("\n")[0];
        const number = chars.split("\n")[1];
        return { system, number };
    }
</script>
</body>
</html>
